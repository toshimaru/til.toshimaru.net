---
title: 2021-09-03 MySQL OPTIMIZE TABLE / ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã®ç¢ºèª
last_modified_at: 2022-05-16
categories: mysql
---

## MySQL OPTIMIZE TABLE

### [Amazon RDS for MySQL ãŒäºˆæƒ³ä»¥ä¸Šã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã™ã‚‹ã¨ãã®ãƒ‡ã‚£ã‚¹ã‚¯ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’æœ€é©åŒ–](https://aws.amazon.com/jp/premiumsupport/knowledge-center/rds-mysql-storage-optimization/)

> ãƒ†ãƒ¼ãƒ–ãƒ«ç”¨ã®é ˜åŸŸã®ä¸€éƒ¨ã¯å®Ÿéš›ã«ä½¿ç”¨ã•ã‚Œãªã„å ´åˆã§ã‚‚å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¾ã™ã€‚innodb_file_per_table ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹å ´åˆ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯æœ‰åŠ¹åŒ–)ã€OPTIMIZE TABLE ã‚’ä½¿ã£ã¦ãã®å®¹é‡ã‚’è§£æ”¾ã§ãã¾ã™ã€‚OPTIMIZE TABLE ã¯ InnoDBã€MyISAMã€ARCHIVE ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¯¾ã—ã¦æ©Ÿèƒ½ã—ã€Amazon RDS ã¯ OPTIMIZE TABLE ã‚³ãƒãƒ³ãƒ‰ã‚’å—ã‘å…¥ã‚Œã¾ã™ãŒã€Amazon RDS ã¯ ALTER TABLE...FORCE ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ã“ã‚ŒãŒç™ºç”Ÿã™ã‚‹ã¨ã€ã€Œãƒ†ãƒ¼ãƒ–ãƒ«ãŒæœ€é©åŒ–ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚ä»£ã‚ã‚Šã«ã€å†ä½œæˆ + åˆ†æã‚’å®Ÿè¡Œã—ã¾ã™ã€ã®ã‚ˆã†ãªè­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ è©³ç´°ã«ã¤ã„ã¦ã¯ã€OPTIMIZE TABLE ã«é–¢ã™ã‚‹ MySQL ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

ğŸ‘†ã§ãƒªãƒ³ã‚¯ã•ã‚Œã¦ã„ã‚‹å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ä¸‹è¨˜ã€‚

[MySQL :: MySQL 5.7 Reference Manual :: 13.7.2.4 OPTIMIZE TABLE Statement](https://dev.mysql.com/doc/refman/5.7/en/optimize-table.html)

### OPTIMIZE TABLE ã¯çŸ­æœŸé–“ã—ã‹ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒ­ãƒƒã‚¯ã—ãªã„

è‹±èªã‚ˆã‚Šæ—¥æœ¬èªã®èª¬æ˜ã®ã»ã†ãŒä¸å¯§ãªã®ã§ã“ã¡ã‚‰ã‹ã‚‰å¼•ç”¨ã™ã‚‹ã€‚

[MySQL :: MySQL 5.6 ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ãƒãƒ‹ãƒ¥ã‚¢ãƒ« :: 13.7.2.4 OPTIMIZE TABLE æ§‹æ–‡](https://dev.mysql.com/doc/refman/5.6/ja/optimize-table.html)

> Mysql 5.6.17 ã‚ˆã‚Šå‰ã¯ã€OPTIMIZE TABLE ã¯ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ DDL (ALGORITHM=INPLACE) ã‚’ä½¿ç”¨ã—ã¾ã›ã‚“ã€‚ãã®çµæœã€OPTIMIZE TABLE ãŒå®Ÿè¡Œä¸­ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¯¾ã—ã¦ã¯ (ã¤ã¾ã‚Šã€ãã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ­ãƒƒã‚¯ä¸­ã¯) ä¸¦åˆ— DML (INSERTã€UPDATEã€DELETE) ãŒè¨±å¯ã•ã‚Œã¾ã›ã‚“ã€‚ã¾ãŸã€ä¸»ã‚­ãƒ¼ã«ç¾ã‚Œã‚‹é †åºã§ã‚­ãƒ¼ãŒæŒ¿å…¥ã•ã‚Œã‚‹ãŸã‚ã€ã‚»ã‚«ãƒ³ãƒ€ãƒªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯ãã‚Œã»ã©åŠ¹ç‡çš„ã«ä½œæˆã•ã‚Œã¾ã›ã‚“ã€‚
>
> 5.6.17 ã®æ™‚ç‚¹ã§ã¯ã€OPTIMIZE TABLE ã¯ã€InnoDB ã®é€šå¸¸ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³åŒ–ã•ã‚ŒãŸãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¸¡æ–¹ã«å¯¾ã—ã¦ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ DDL (ALGORITHM=INPLACE) ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚OPTIMIZE TABLE ã«ã‚ˆã£ã¦ãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã€ALTER TABLE ... FORCE ã®ä¸‹ã§å®Ÿè¡Œã•ã‚Œã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«å†æ§‹ç¯‰ã¯ç¾åœ¨ã€ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ DDL (ALGORITHM=INPLACE) ã‚’ä½¿ç”¨ã—ã¦å®Ÿè¡Œã•ã‚Œã€çŸ­æœŸé–“ã—ã‹ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒ­ãƒƒã‚¯ã—ãªã„ãŸã‚ã€ä¸¦åˆ— DML æ“ä½œã®ãŸã‚ã®ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ãŒçŸ­ç¸®ã•ã‚Œã¾ã™ã€‚

ãƒã‚¤ãƒ³ãƒˆã¯**æ–°ã—ã„MySQLãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã‚ã‚Œã°ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ DDLãŒåŠ¹ãã®ã§ã€ŒçŸ­æœŸé–“ã—ã‹ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒ­ãƒƒã‚¯ã—ãªã„ã€ã®ã§ã€Œãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ãŒçŸ­ç¸®ã€ã•ã‚Œã¦ã„ã‚‹**ã“ã¨ã ã€‚

### ã“ã†æ€ã£ãŸã£ã™

<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">RDSãƒ¬ãƒ™ãƒ«ãªã‚‰ã‚‚ã†è‡ªå‹•optimize tableã¨ã‹ã‚„ã£ã¦ãã‚Œã¦ã‚“ã®ã‹ãªã£ã¦æ€ã£ãŸã‚‰ optimize table ã„ã¾ã ã«æ‰‹å‹•ã§æ‰“ãŸãªãã‚ƒãªã‚‰ã‚“ã‹ãƒ¼</p>&mdash; toshimaru (@toshimaru_e) <a href="https://twitter.com/toshimaru_e/status/1433583981232934912?ref_src=twsrc%5Etfw">September 3, 2021</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

## ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã®ç¢ºèª

[MySQL 5.7ã¨8.0ã§ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹ï¼ˆsys.innodb_lock_waitsãƒ“ãƒ¥ãƒ¼ï¼‰ - Qiita](https://qiita.com/hmatsu47/items/607d176e885f098262e8)

ãƒ­ãƒƒã‚¯ã®çŠ¶æ…‹ã‚’ç¢ºèªã—ãŸã„ã¨ãã®ã‚¯ã‚¨ãƒªã€‚

```
mysql> SELECT * FROM  sys.innodb_lock_waits\G
*************************** 1. row ***************************
                wait_started: 2018-01-07 13:09:32
                    wait_age: 00:00:02
               wait_age_secs: 2
                locked_table: `lock_test`.`lock_test`
                locked_index: PRIMARY
                 locked_type: RECORD
              waiting_trx_id: 92210
         waiting_trx_started: 2018-01-07 13:07:49
             waiting_trx_age: 00:01:45
     waiting_trx_rows_locked: 2
   waiting_trx_rows_modified: 0
                 waiting_pid: 6
               waiting_query: UPDATE lock_test.lock_test SET val1=6 WHERE id=6
             waiting_lock_id: 92210:112:3:7
           waiting_lock_mode: X
             blocking_trx_id: 92209
                blocking_pid: 4
              blocking_query: NULL
            blocking_lock_id: 92209:112:3:7
          blocking_lock_mode: X
        blocking_trx_started: 2018-01-07 13:04:45
            blocking_trx_age: 00:04:49
    blocking_trx_rows_locked: 1
  blocking_trx_rows_modified: 1
     sql_kill_blocking_query: KILL QUERY 4
sql_kill_blocking_connection: KILL 4
1 row in set, 3 warnings (0.00 sec)
```
