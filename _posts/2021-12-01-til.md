---
title: 2021-12-01 Ruby x jemalloc
last_modified_at: 2022-01-04
---

## Ruby x jemalloc

### Railsアプリのメモリ断片化を抑制する

Ruby（Railsアプリケーション）のメモリ肥大化はメモリの断片化が原因。

これに対しては下記の２つのソリューションが推奨されている。

> 1. Either use a completely different memory allocator than the one in glibc – usually jemalloc
> 2. Set the magical environment variable `MALLOC_ARENA_MAX=2`.

[What causes Ruby memory bloat? – Joyful Bikeshedding](https://www.joyfulbikeshedding.com/blog/2019-03-14-what-causes-ruby-memory-bloat.html)

### メモリアロケーターをjemallocに切り替える

jemalloc が使える環境ならメモリアロケーターを jemalloc に切り替えるのが良さそう。

> Rubyをjemalloc付きでコンパイルする必要はありません（一応可能ですが）。`LD_PRELOAD`を使えば動的に読み込めます。

[Ruby: mallocでマルチスレッドプログラムのメモリが倍増する理由（翻訳）｜TechRacho by BPS株式会社](https://techracho.bpsinc.jp/hachi8833/2017_12_28/50109)
(原文: [Malloc Can Double Multi-threaded Ruby Program Memory Usage](https://www.speedshop.co/2017/12/04/malloc-doubles-ruby-memory.html))

`LD_PRELOAD` に shared object のパスを渡して ruby を実行すればOKそう。

```
LD_PRELOAD=/path/to/libjemalloc.so.2
```

参考. [Getting Started · jemalloc/jemalloc Wiki](https://github.com/jemalloc/jemalloc/wiki/Getting-Started)

### 確認方法

下記のようにとあるRails/Rubyプロセスにおいて jemalloc を使われているかは下記の通り確認できる。

```console
$ strings /proc/{process_no}/maps  | grep jemalloc
7f59e5ff8000-7f59e6028000 r-xp 00000000 103:03 12712                     /usr/lib64/libjemalloc.so.1
7f59e6028000-7f59e6227000 ---p 00030000 103:03 12712                     /usr/lib64/libjemalloc.so.1
7f59e6227000-7f59e6229000 rw-p 0002f000 103:03 12712                     /usr/lib64/libjemalloc.so.1
```

[Rubyアプリケーションのメモリ使用量上昇問題をjemallocを使うことで解決しました - Studyplus Engineering Blog](https://tech.studyplus.co.jp/entry/2019/09/09/094140)

## パフォーマンス測定

[Fullstaq Ruby](https://fullstaqruby.org/) では内部的に jemalloc をアロケーターにしたRubyを使っているようだ。

Fullstaq Ruby は jemalloc のPro/Con についてこう述べている。

> * Pro: Uses less memory than the original Ruby.
> * Pro: Is usually faster than the original Ruby. (How much faster? [AppFolio benchmark](http://engineering.appfolio.com/appfolio-engineering/2018/2/1/benchmarking-rubys-heap-malloc-tcmalloc-jemalloc), [Ruby Inside benchmark](https://medium.com/rubyinside/how-we-halved-our-memory-consumption-in-rails-with-jemalloc-86afa4e54aa3))
> * Con: May not be compatible with all gems (though such problems should be rare).

下記のベンチマークが参考になった。

[Benchmarking Ruby's Heap: malloc, tcmalloc, jemalloc — AppFolio Engineering](https://engineering.appfolio.com/appfolio-engineering/2018/2/1/benchmarking-rubys-heap-malloc-tcmalloc-jemalloc)

jemalloc が 10% ほど高速っぽい。

### 改善事例

- [How jemalloc improved memory usage of our Rails application](https://medium.com/code-wild/how-jemalloc-improved-memory-usage-of-our-rails-application-7038d5926d4)
- [How we decreased our memory usage with jemalloc - DEV Community](https://dev.to/devteam/how-we-decreased-our-memory-usage-with-jemalloc-4d5n)
- [Fullstaq Ruby: First impressions, and how to migrate your Docker/Kubernetes Ruby apps today - DEV Community](https://dev.to/evilmartians/fullstaq-ruby-first-impressions-and-how-to-migrate-your-docker-kubernetes-ruby-apps-today-4fm7)

## 参考

- [jemalloc](http://jemalloc.net/)
	+ Facebook で作られている memory allocator のようだ
