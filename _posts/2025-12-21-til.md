---
title: 2025-12-22 mysql外部キー追加のDDLアルゴリズム
categories: mysql
---

外部キー操作のオンライン DDL サポートは公式ドキュメントによると下記の通り。

| 操作 | インスタント | インプレース | テーブルの再構築 | 同時 DML の許可 | メタデータの変更のみ |
| --- | --- | --- | --- | --- | --- |
| **外部キー制約の追加** | いいえ | はい* | いいえ | はい | はい |
| **外部キー制約の削除** | いいえ | はい | いいえ | はい | はい |

see. [MySQL :: MySQL 8.0 リファレンスマニュアル :: 15.12.1 オンライン DDL 操作](https://dev.mysql.com/doc/refman/8.0/ja/innodb-online-ddl-operations.html#online-ddl-foreign-key-operations)

「インプレース：はい」となっているが、条件付きの「はい」であることに注意が必要。

> `INPLACE` アルゴリズムは、`foreign_key_checks` が無効な場合にサポートされます。それ以外の場合は、`COPY` アルゴリズムのみがサポートされます。
> 
> ```sql
> ALTER TABLE tbl1 ADD CONSTRAINT fk_name FOREIGN KEY index (col1)
>   REFERENCES tbl2(col2) referential_actions;
> ```

## INPLACE 実行のために foreign_key_checks=0 で実行する

`INPLACE` アルゴリズムは`foreign_key_checks=0`の時に有効になるので、`COPY`アルゴリズムを嫌う場合は、外部キー制約チェックを無効化してから外部キーを追加すると良い。
